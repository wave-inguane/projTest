<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Home</title>
        <link href="css/styles.css" rel="stylesheet" type="text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script src="scripts/amazon/sha2.js" type="text/javascript"></script>
        <script src="scripts/amazon/amazon_api.js" type="text/javascript"></script>

        <!-- COPY AND PASTE THE WEB SETUP SNIPPET HERE: -->
        <!-- COPY AND PASTE THE WEB SETUP SNIPPET HERE: -->
        <script src="https://www.gstatic.com/firebasejs/3.5.2/firebase.js"></script>
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyDs8pLSj9ZIqrkm0NAPV3cj58vPBghHFg8",
                authDomain: "dbgamespider.firebaseapp.com",
                databaseURL: "https://dbgamespider.firebaseio.com",
                storageBucket: "dbgamespider.appspot.com",
                messagingSenderId: "315500031833"
            };
            firebase.initializeApp(config);
        </script>
        <!-- END OF WEB SNIPPET -->
        <!-- END OF WEB SNIPPET -->
        <link href="css/style.css" rel="stylesheet" type="text/css" media="screen" />
        <script src="https://www.gstatic.com/firebasejs/ui/live/0.5/firebase-ui-auth.js"></script>
        <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/live/0.5/firebase-ui-auth.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1">

    </head>
    <body>
        <!--                                  NAVIGATION                              -->
        <div id="header">
            <img alt="Home Page" class="align-left medium" src="http://pngimg.com/upload/spider_PNG45.png">
            <div id="nav">
                <ul id="put-nav-right-top-conner">
                    <li id="username_display"></li>
                    <li>
                        <a href="index.html">Home</a>
                    </li>
                    <li>
                        <a href="login.html">Login</a>
                    </li>
                    <li>
                        <a href="register.html">Register</a>
                    </li>
                    <li>
                        <a href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </div>

        <!--                           SEARCH AND BROWSE LINKS                         -->
        <div id="content">
            <div id="feature">
                <h2><a href="index.html" target="_parent">Game Spider</a></h2>
            </div>

            <div id="container">
                <!--<h3>FirebaseUI Demo</h3>-->
                <div id="loading"></div>
                <div id="loaded" class="hidden">
                    <div id="main">
                        <div id="user-signed-in" class="hidden">
                            <div id="user-info">
                                <div id="photo-container">
                                    <img id="photo" />
                                </div>
                                <div id="name"></div>
                                <div id="emailx"></div>
                                <div class="clearfix"></div>
                            </div>
                            <p>
                                <button id="sign-out">Sign Out</button>
                                <button id="delete-account">Delete account</button>
                            </p>
                        </div>
                        <div id="user-signed-out" class="hidden">
                            <!--<h4>You are signed out.</h4> -->
                            <p></p>
                            <div id="firebaseui-spa">
                                <!-- <h5>Single Page Application mode:</h5> -->
                                <div id="firebaseui-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script src="scripts/oAuth.js"></script>
            <!-- end oAuth -->

            <div class="row1">
                <h1 class="centered-text">HOME</h1>
            </div>
            <div class="row2">
                <nav>
                    <table align="center">
                        <tr class="tabs">
                            <th>
                                <a class="tab" href="#search_games" style="color:black">Search Games</a>
                            </th>
                            <th>&nbsp;</th>
                            <th>
                                <a class="tab" href="#browse_games" style="color:black">Browse Games</a>
                            </th>
                        </tr>
                    </table>
                </nav>
            </div>
            <!--         <div class="row3" >      SEARCH GAME        </div>           -->
            <div class="panel" id="search_games">
                <h3 class="centered-text">Search for Games</h3>
                <form>
                    <div class="align-form">
                        <!--Temp padding &nbsp;&nbsp; to be replace with css element-->
                        <label>Name: &nbsp;&nbsp;&nbsp; <input id="game_name" maxlength="15" placeholder="" type="text"></label>
                    </div>
                    <div class="align-form">
                        <label>Platform: <input id="platform_name" maxlength="15" placeholder="" type="text"></label>
                    </div>
                    <div class="align-form">
                        <button class="submit" data-submission="search_games" type="button">Submit</button> <button class="clear_form" type="button">Clear</button>
                    </div>
                </form>
            </div>
            <!--      <div class="row4" >                         BROWSE GAME         </div>                 -->
            <div class="panel" id="browse_games">
                <h4>Browse for Games</h4>
                <form>
                    <div class="align-form">
                        <label>Platform: <input id="platform_name2" maxlength="15" placeholder="xbox" type="text"></label>
                    </div>
                    <div class="align-form">
                        <button class="submit" data-submission="browse_games" type="button">Submit</button> <button class="clear_form" type="button">Clear</button>
                    </div>
                </form>
            </div>
            <!--                          SEARCH RESULTS                           -->
            <div class="row5" align="center">

                <!--  SEARCH TRACKER -->
                <p id="tracking"></p>

                <div class="column1" id="table" align="center">
                    <!-- REACT RESULTS HERE -->
                </div>
                <div class="column2" id="compare" align="center">
                    <!-- COMPARISON PRICES HERE -->      
                </div>
                <div class="column3" id="visualization">
                    <!-- INFORMATION VISUALIZATION -->
                </div>
            </div>
        </div>
        <!--                                FOOTER                                  -->
        <div class="row1" id="footer">
            <p>&copy; Copyright 2016 Tom, Avelino, and Chris </p>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script> 
        <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> 
        <script src="scripts/liquidFillGauge.js" language="JavaScript"></script>
        <script src="https://fb.me/react-15.0.0.js"></script>
        <script src="https://fb.me/react-dom-15.0.0.js"></script>
		<script src="https://fb.me/react-with-addons-0.14.0.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
        <script src="scripts/home.js" ></script>
<!--		<link rel="stylesheet" type="text/css" href="scripts/jasmine/lib/jasmine-2.5.2/jasmine.css"> 
        <script type="text/javascript" src="scripts/jasmine/lib/jasmine-2.5.2/jasmine.js"></script>
        <script type="text/javascript" src="scripts/jasmine/lib/jasmine-2.5.2/jasmine-html.js"></script>
        <script type="text/javascript" src="scripts/jasmine/lib/jasmine-2.5.2/boot.js"></script>  -->
        <script type="text/babel">
            var selected_index = 0;
            
            class Table extends React.Component{
              constructor() {
                  super();
                  this.state = {page: -1};
                  this.incrementPage = this.incrementPage.bind(this);
            	  this.decrementPage = this.decrementPage.bind(this);
              }
              componentWillMount(){
            	ReactThis = this;
              }
              incrementPage() {
                  var num = this.state.page;
                  num = num + 1;
                  this.setState({page: num});
                  get_bestbuy_prices(num);
              }
              decrementPage() {
                  var num = this.state.page;
                  num = num - 1;
                  this.setState({page: num});
                  get_bestbuy_prices(num);
              }
              render(){
                  console.log(this.state.page);
                  return <div>
                            {CreateTable(this.state.page)}
            				<PreviousButton id="previousButton" handler={this.decrementPage} />
                            <NextButton handler={this.incrementPage} />
                             </div>;
              }
                getState(){
                    return this.state.page;
                }
            };
            
            class NextButton extends React.Component{
              render(){
                  return <button id="nextButton" onClick = {this.props.handler}>Next</button>  
              }
            };
            
            class PreviousButton extends React.Component{
              render(){
                  return <button id="previousButton" onClick = {this.props.handler}>Back</button>  
              }
            };
            
            ReactDOM.render(   
              <Table />,
              document.getElementById('table')
            );
            
            function CreateTable(page=0){
            
               var rows = [];
               if(page == -1)
                   return (<table></table>);
               for (var i = page*5; i < (page*5) + 5; i++){
                   rows.push(GameRow(i));
               }
               return (
                  <table>
                    <thead>
                    </thead>
                    <tbody>{rows}</tbody>
                  </table>
                );
            }
            
            function GameRow(i){
                return (
                  <tr>
                    <td onClick={compareResults.bind(this, i)}>{games[i].title}</td>
                  </tr>
                );
            }
            
            //Found online
            function isNumeric(n) {
              return !isNaN(parseFloat(n)) && isFinite(n);
            }
            
            function compareResults(i) {
                var game = games[i];
                selected_index = i;
                
                ReactDOM.render(<CompareTable game={game.title} i={i} />, document.getElementById('compare'));
            	
                
            	var amazonPrice = game.amazon_price;
            	var bestbuyPrice = game.bestbuy_price;
            	    
            	var percent;
                if (isNumeric(amazonPrice) && isNumeric(bestbuyPrice)) 
                    {
            	if(amazonPrice > bestbuyPrice)
            	    percent = (bestbuyPrice * 1.0)/amazonPrice * 100;
            	else
                    percent = (amazonPrice * 1.0)/bestbuyPrice * 100;
                    }
                else percent = 0;
                
                /*if (isNumeric(amazonPrice) && isNumeric(bestbuyPrice))    
                    percent = (amazonPrice / (amazonPrice+bestbuyPrice))*100;
                else
                    percent = 0;*/
                
               /*if (isNumeric(amazonPrice) && isNumeric(bestbuyPrice)) 
                   percent = (amazonPrice / bestbuyPrice)*100;
            	else
                    percent = 0;*/
                
                // Taken from http://bl.ocks.org/brattonc/5e5ce9beee483220e2f6 	
            	if (gauge1 == null)
            	    gauge1 = loadLiquidFillGauge("fillgauge1", percent)
            	else
            	    gauge1.update(percent);
                var config1 = liquidFillGaugeDefaultSettings();
                config1.circleColor = "#FF7777";
                config1.textColor = "#FF4444";
                config1.waveTextColor = "#FFAAAA";
                config1.waveColor = "#FFDDDD";
                config1.circleThickness = 0.2;
                config1.textVertPosition = 0.2;
                config1.waveAnimateTime = 1000;
            
            }
            
            class CompareTable extends React.Component{
              constructor() {
                  super();
              }
              
              render(){
                  return <div>
                      <table>
                         <thead>
                         </thead>
                         <tbody>
            			    <tr><td></td><td>Price</td></tr>
            			    <tr><td>Amazon</td><td>${games[selected_index].amazon_price}</td></tr>
            				<tr><td>Best Buy</td><td>${games[selected_index].bestbuy_price}</td></tr>
            			 </tbody>
                         </table>
                   <p>The Lower Price is this Percent of the Higher Price:</p>
            </div>       
			
                            
              }
            };
            
            //------------------------------------------------------------------------------------
            //         Information visualization Implementation goes here
            //------------------------------------------------------------------------------------
            
            var gauge1;
            
            class InformationVisualization extends React.Component {
                render() {
                    return (
                            <div>
                           
                                <svg id="fillgauge1" position="center" width="97%" height="200" ></svg>
                            </div>
                    );
                }
            }
            ReactDOM.render(<Table />,document.getElementById('table'));
            ReactDOM.render(<InformationVisualization />,document.getElementById('visualization'));
			
	        //JASMINE
			
			/*
			describe('searchIndex', function() {
                var TestUtils = React.addons.TestUtils;
                var component, element, renderedDOM;
                beforeEach(function(){
                    element = React.createElement(Table);
                    component = TestUtils.renderIntoDocument(element);
					//spyOn(ClassName.prototype, "get_bestbuy_prices");
                });
                it("Has correct Buttons", function(){
                    let button = TestUtils.scryRenderedDOMComponentsWithTag(component,"button");
					console.log(button[0]);     //previousButton 
					console.log(button[1]);     //nextButton
                    expect(button[0]).not.toBeUndefined();
                    expect(button[0].innerHTML).toBe("Back");
					expect(button[1]).not.toBeUndefined();
					expect(button[1].innerHTML).toBe("Next");
                });
                it("Has an initial page number -1", function(){
                    expect(component.state.page).toEqual(-1);
                });
                it("Changes page number correctly on button hits", function(){
				    let button = TestUtils.scryRenderedDOMComponentsWithTag(component,"button");
					console.log(button[0]);     //previousButton 
					console.log(button[1]);     //nextButton
					TestUtils.Simulate.click(button[0]);
					expect(component.this.state.page).toEqual(0);
				});
				it("Clear button clears the form", function(){
	                let textfields = $("input");
		            let buttons = $("button");
		            let clearButton = buttons[1];
		
		             clearButton.click();
		
		             expect(textfields[0].value).toBe("");
		             expect(textfields[1].value).toBe("");

		        });
            });
			*/
			
            
        </script>
        <!--
            //-------------------------------------------------------------
            //       TRACK THE STATE OF GAME SEARCH
            //--------------------------------------------------------------
            -->
        <script>
            //TODO: make all variable generic
            //used for item search
            var gameTracker = [ ];
            var countTracker= [ ];
            var index;

            //------------------------------------------------
            // use this function to reset state
            //------------------------------------------------
            function resetGameTracker(){
                localStorage.removeItem("hotgames");
                localStorage.removeItem("numOfSearches");
            }

            function trackSearchedGamesState(){

                var display = document.getElementById("tracking");
                //resetGameTracker();
                if(typeof(Storage) !== "undefined") {

                    var game_name = $("#game_name").val().toLowerCase();
                    //var platform_name;// = $("#platform_name2").val().toLowerCase(); //search by platform
                    //var curr_name = ((game_name !== null) ||  (game_name !== "")) ? game_name : platform_name;

                    var curr_name = game_name;
                    function findGame(element) {
                        return element == curr_name;
                    }
                    // storing our arrays as a strings
                    // initialize storage
                    if(localStorage.getItem("hotgames") == null){
                        localStorage.setItem("hotgames", JSON.stringify(gameTracker));
                        localStorage.setItem("numOfSearches", JSON.stringify(countTracker));
                    }

                    // retrieving our data and converting it back into an array
                    retrievedGameNames = localStorage.getItem("hotgames");
                    timesSearched = localStorage.getItem("numOfSearches");
                    if(retrievedGameNames != null){
                        gameTracker = JSON.parse(retrievedGameNames);
                        countTracker = JSON.parse(timesSearched);

                        index = gameTracker.findIndex(findGame);
                        if(index == -1){ //if not tracked
                            gameTracker.push(curr_name);
                            countTracker.push(1);
                            localStorage.setItem("hotgames", JSON.stringify(gameTracker));
                            localStorage.setItem("numOfSearches", JSON.stringify(countTracker));
                            display.innerHTML = curr_name+ " searched: " +1+" "+ "times"+"<br />";

                        }else{// inc count
                            countTracker[index] = countTracker[index] + 1;
                            localStorage.setItem("numOfSearches", JSON.stringify(countTracker));
                        }
                    }

                    if( typeof(gameTracker[index]) == "undefined"){
                        gameTracker[index]  = 0;
                        countTracker[index] = 0;
                    }else if(gameTracker[index] == 0){
                        display.innerHTML = "first time searched "+"<br />";
                    }else{
                        display.innerHTML = gameTracker[index]+ " searched: " +countTracker[index]+" "+ "times"+"<br />";
                    }

                } else {
                    display.innerHTML = "Sorry, your browser does not support web storage...";
                }
            }
        </script>

    </body>
</html>